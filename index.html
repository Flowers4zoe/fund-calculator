<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>基金实时估值器 Pro+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
            min-height: 100vh;
            color: #e2e8f0;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-field {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.2);
            transition: all 0.3s ease;
        }
        .input-field:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }
        .stock-row {
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .positive { color: #ef4444; font-weight: 600; }  /* A股红涨 */
        .negative { color: #22c55e; font-weight: 600; }  /* A股绿跌 */
        .result-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(168, 85, 247, 0.3) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }
        .btn-primary:active {
            transform: scale(0.96);
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #qrcode img {
            margin: 0 auto;
            border-radius: 8px;
            padding: 8px;
            background: white;
        }
        .data-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 9999px;
            background: rgba(255,255,255,0.1);
            color: #94a3b8;
        }
    </style>
</head>
<body class="pb-24">

    <!-- Header -->
    <header class="sticky top-0 z-50 glass-panel border-b border-indigo-500/30">
        <div class="max-w-lg mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg">基</div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-tight">基金实时估值 Pro+</h1>
                    <div class="flex items-center gap-2">
                        <span class="data-tag">实时数据</span>
                        <span id="marketStatus" class="text-[10px] text-emerald-400">● 交易中</span>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div id="clock" class="text-base font-mono font-bold text-slate-200">--:--:--</div>
                <div class="text-[10px] text-slate-400">数据延迟<1秒</div>
            </div>
        </div>
    </header>

    <main class="max-w-lg mx-auto px-4 py-4 space-y-4">

        <!-- 基金信息 -->
        <section class="glass-panel rounded-2xl p-4 space-y-3">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-sm font-semibold text-indigo-300 uppercase tracking-wider flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    基金配置
                </h2>
                <div class="flex space-x-2">
                    <button onclick="loadDemoData()" class="text-xs bg-indigo-600/30 hover:bg-indigo-600/50 text-indigo-300 px-3 py-1.5 rounded-full transition border border-indigo-500/30">
                        加载示例
                    </button>
                    <button onclick="clearAllData()" class="text-xs bg-red-900/30 text-red-400 hover:bg-red-900/50 px-3 py-1.5 rounded-full transition border border-red-500/30">
                        清空
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="space-y-1">
                    <label class="block text-xs text-slate-400 font-medium">基金代码</label>
                    <input type="text" id="fundCode" placeholder="如: 022365" class="input-field w-full px-3 py-2.5 rounded-lg text-sm text-white placeholder-slate-500 font-mono">
                </div>
                <div class="space-y-1">
                    <label class="block text-xs text-slate-400 font-medium">基金名称</label>
                    <input type="text" id="fundName" placeholder="如: 永赢科技智选" class="input-field w-full px-3 py-2.5 rounded-lg text-sm text-white placeholder-slate-500">
                </div>
            </div>
        </section>

        <!-- 持仓列表 -->
        <section class="glass-panel rounded-2xl p-4">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h2 class="text-sm font-semibold text-indigo-300 uppercase tracking-wider flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        重仓股配置
                    </h2>
                    <p class="text-[10px] text-slate-500 mt-0.5">支持自动获取实时行情</p>
                </div>
                <div class="text-right bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-700">
                    <div class="text-[10px] text-slate-400 uppercase">总权重</div>
                    <div id="totalWeight" class="text-lg font-bold text-indigo-400 font-mono">0%</div>
                </div>
            </div>

            <div id="stockList" class="space-y-2 max-h-64 overflow-y-auto no-scrollbar mb-3">
                <!-- 动态生成 -->
            </div>

            <button onclick="addStockRow()" class="w-full py-3 border border-dashed border-slate-600 rounded-xl text-slate-400 hover:border-indigo-500 hover:text-indigo-400 hover:bg-indigo-500/10 transition flex items-center justify-center space-x-2 group">
                <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <span class="text-sm font-medium">添加成分股</span>
            </button>
        </section>

        <!-- 实时行情操作区 -->
        <section class="glass-panel rounded-2xl p-4 border-indigo-500/20">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-sm font-semibold text-indigo-300 uppercase tracking-wider flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    实时行情
                </h2>
                <div class="flex gap-2">
                    <button onclick="fetchRealTimeQuotes()" id="fetchBtn" class="btn-success text-white text-xs px-4 py-2 rounded-lg font-medium flex items-center gap-1.5 transition active:scale-95">
                        <svg id="fetchIcon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        <span>自动获取</span>
                    </button>
                    <button onclick="fillRandomChanges()" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-2 rounded-lg transition">
                        模拟
                    </button>
                </div>
            </div>
            
            <div id="quoteInputs" class="grid grid-cols-2 gap-2 max-h-56 overflow-y-auto no-scrollbar">
                <!-- 动态生成输入框 -->
            </div>
            
            <div id="lastUpdate" class="mt-2 text-[10px] text-slate-500 text-right hidden">
                最后更新: <span class="font-mono text-slate-400">--:--:--</span>
            </div>
        </section>

        <!-- 计算按钮 -->
        <button onclick="calculateNAV()" class="w-full btn-primary text-white font-bold py-4 rounded-2xl text-lg tracking-wide transition active:scale-95 flex items-center justify-center space-x-2 shadow-xl shadow-indigo-500/30">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
            <span>计算实时估值</span>
        </button>

        <!-- 结果展示 -->
        <section id="resultSection" class="hidden space-y-4">
            <!-- 主结果卡片 -->
            <div class="result-card rounded-2xl p-6 border relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                
                <div class="flex justify-between items-start mb-6 relative z-10">
                    <div>
                        <h3 class="text-indigo-200 text-sm mb-1 font-medium">估算净值涨跌幅</h3>
                        <div id="resultPercent" class="text-5xl font-bold text-white tracking-tight">--</div>
                        <div class="text-xs text-indigo-200/70 mt-1">基于前十大重仓</div>
                    </div>
                    <div class="text-right bg-black/20 p-3 rounded-xl backdrop-blur-sm">
                        <div class="text-[10px] text-indigo-200 uppercase tracking-wider mb-0.5">仓位覆盖</div>
                        <div id="coveragePercent" class="text-2xl font-bold text-white font-mono">--%</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 text-xs relative z-10">
                    <div class="bg-black/20 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                        <div class="flex items-center gap-1.5 mb-1.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                            <span class="text-indigo-200/80 text-[10px] uppercase font-medium">正向贡献 Top3</span>
                        </div>
                        <div id="topPositive" class="text-red-300 font-medium text-[11px] leading-relaxed">--</div>
                    </div>
                    <div class="bg-black/20 backdrop-blur-sm rounded-xl p-3 border border-white/10">
                        <div class="flex items-center gap-1.5 mb-1.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                            <span class="text-indigo-200/80 text-[10px] uppercase font-medium">负向贡献 Top3</span>
                        </div>
                        <div id="topNegative" class="text-green-300 font-medium text-[11px] leading-relaxed">--</div>
                    </div>
                </div>
            </div>

            <!-- 贡献度图表 -->
            <div class="glass-panel rounded-2xl p-4">
                <h3 class="text-xs font-semibold text-slate-400 mb-4 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                    贡献度分布
                </h3>
                <div class="relative h-48">
                    <canvas id="contributionChart"></canvas>
                </div>
            </div>

            <!-- 数据明细表 -->
            <div class="glass-panel rounded-2xl p-4 overflow-hidden">
                <h3 class="text-xs font-semibold text-slate-400 mb-3">明细数据</h3>
                <div class="overflow-x-auto -mx-4 px-4">
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="text-slate-500 border-b border-slate-700/50">
                                <th class="text-left py-2 font-medium">股票</th>
                                <th class="text-right py-2 font-medium">权重</th>
                                <th class="text-right py-2 font-medium">实时涨跌</th>
                                <th class="text-right py-2 font-medium">净值贡献</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody" class="divide-y divide-slate-800/50">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 二维码分享 -->
        <section class="glass-panel rounded-2xl p-6 text-center border-indigo-500/20">
            <h3 class="text-sm font-semibold text-indigo-300 mb-3 flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                扫码手机使用
            </h3>
            <p class="text-[11px] text-slate-500 mb-4">微信/浏览器扫描下方二维码，即可在手机上使用此工具</p>
            <div id="qrcode" class="flex justify-center mb-3"></div>
            <div class="text-[10px] text-slate-600 font-mono break-all bg-slate-900/50 p-2 rounded" id="currentUrl"></div>
        </section>

        <!-- 免责声明 -->
        <div class="text-[10px] text-slate-600 text-center leading-relaxed px-2 pb-4">
            <p>免责声明：数据来自新浪财经公开接口，仅供参考。</p>
            <p>基金实际净值受基金经理调仓、现金头寸等因素影响，请以官方披露为准。</p>
        </div>

    </main>

    <script>
        // 时钟
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('zh-CN', {hour12: false});
            
            // 判断交易时间 (9:30-11:30, 13:00-15:00)
            const hour = now.getHours();
            const minute = now.getMinutes();
            const time = hour * 100 + minute;
            const isTradeTime = (time >= 930 && time <= 1130) || (time >= 1300 && time <= 1500);
            const statusEl = document.getElementById('marketStatus');
            if (isTradeTime) {
                statusEl.innerHTML = '● <span class="animate-pulse">交易中</span>';
                statusEl.className = 'text-[10px] text-emerald-400 font-medium';
            } else {
                statusEl.textContent = '● 休市';
                statusEl.className = 'text-[10px] text-slate-500';
            }
        }, 1000);

        // 示例数据
        const demoData = [
            {code: '600183', name: '生益科技', weight: 9.11},
            {code: '300308', name: '中际旭创', weight: 8.85},
            {code: '002463', name: '沪电股份', weight: 8.84},
            {code: '300502', name: '新易盛', weight: 8.75},
            {code: '002916', name: '深南电路', weight: 8.72},
            {code: '300394', name: '天孚通信', weight: 8.56},
            {code: '002384', name: '东山精密', weight: 3.98},
            {code: '603228', name: '景旺电子', weight: 2.98},
            {code: '601138', name: '工业富联', weight: 2.86},
            {code: '603083', name: '剑桥科技', weight: 2.83}
        ];

        let chartInstance = null;

        // 初始化
        function init() {
            loadFromLocalStorage();
            if (document.getElementById('stockList').children.length === 0) {
                addStockRow();
            }
            updateTotalWeight();
            renderQuoteInputs();
            generateQRCode();
            
            // 自动获取一次行情（如果已有数据）
            const rows = document.querySelectorAll('.stock-row');
            if (rows.length > 0 && rows[0].querySelector('.stock-code').value) {
                setTimeout(fetchRealTimeQuotes, 1000);
            }
        }

        // 生成二维码
        function generateQRCode() {
            const url = window.location.href;
            document.getElementById('currentUrl').textContent = url;
            
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            new QRCode(qrcodeDiv, {
                text: url,
                width: 128,
                height: 128,
                colorDark : "#1e1b4b",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // 添加股票行
        function addStockRow(data = null) {
            const container = document.getElementById('stockList');
            const div = document.createElement('div');
            div.className = 'stock-row flex gap-2 items-center bg-slate-800/30 p-2 rounded-xl border border-slate-700/50';
            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" placeholder="代码" class="input-field w-full px-3 py-2 rounded-lg text-sm text-white placeholder-slate-600 stock-code font-mono uppercase" value="${data ? data.code : ''}">
                </div>
                <div class="flex-1">
                    <input type="text" placeholder="名称" class="input-field w-full px-3 py-2 rounded-lg text-sm text-white placeholder-slate-600 stock-name" value="${data ? data.name : ''}">
                </div>
                <div class="w-20">
                    <input type="number" step="0.01" placeholder="%" class="input-field w-full px-2 py-2 rounded-lg text-sm text-white text-right stock-weight font-mono" value="${data ? data.weight : ''}" onchange="updateTotalWeight(); renderQuoteInputs();">
                </div>
                <button onclick="this.parentElement.remove(); updateTotalWeight(); renderQuoteInputs();" class="w-8 h-8 flex items-center justify-center text-slate-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            container.appendChild(div);
        }

        // 更新总权重
        function updateTotalWeight() {
            const weights = Array.from(document.querySelectorAll('.stock-weight')).map(input => parseFloat(input.value) || 0);
            const total = weights.reduce((a, b) => a + b, 0);
            const el = document.getElementById('totalWeight');
            el.textContent = total.toFixed(2) + '%';
            el.className = total > 100 ? 'text-lg font-bold text-red-400 font-mono' : 'text-lg font-bold text-indigo-400 font-mono';
        }

        // 渲染行情输入区
        function renderQuoteInputs() {
            const container = document.getElementById('quoteInputs');
            container.innerHTML = '';
            const rows = document.querySelectorAll('.stock-row');
            
            rows.forEach((row, index) => {
                const code = row.querySelector('.stock-code').value || `股票${index+1}`;
                const name = row.querySelector('.stock-name').value || '';
                
                const div = document.createElement('div');
                div.className = 'bg-slate-800/40 rounded-lg p-2.5 border border-slate-700/50 hover:border-indigo-500/30 transition';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1.5">
                        <span class="text-xs font-bold text-slate-300 font-mono">${code}</span>
                        <span class="text-[10px] text-slate-500 truncate max-w-[80px]">${name}</span>
                    </div>
                    <div class="flex items-center gap-1 relative">
                        <input type="number" step="0.01" onchange="validateChange(this)" class="quote-change w-full bg-slate-900/80 border border-slate-600 rounded-lg px-2 py-1.5 text-sm text-white text-center font-mono font-bold" placeholder="0.00" oninput="autoCalculate()">
                        <span class="text-xs text-slate-500 absolute right-2 pointer-events-none">%</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 获取实时行情（核心功能）
        async function fetchRealTimeQuotes() {
            const rows = document.querySelectorAll('.stock-row');
            if (rows.length === 0) {
                alert('请先添加股票代码');
                return;
            }

            const btn = document.getElementById('fetchBtn');
            const btnText = btn.querySelector('span');
            const icon = document.getElementById('fetchIcon');
            
            btn.disabled = true;
            btnText.textContent = '获取中...';
            icon.classList.add('loading');
            
            const stockList = [];
            rows.forEach((row, index) => {
                const code = row.querySelector('.stock-code').value.trim();
                if (code) {
                    stockList.push({index, code: formatStockCode(code)});
                }
            });

            try {
                // 使用新浪财经API（支持跨域JSONP）
                const codes = stockList.map(s => s.code).join(',');
                const script = document.createElement('script');
                const callbackName = 'quoteCallback_' + Date.now();
                
                window[callbackName] = function(data) {
                    delete window[callbackName];
                    document.head.removeChild(script);
                    processQuoteData(stockList, data);
                };

                // 新浪接口返回的是JavaScript变量，不是纯JSON，需要用特殊方式处理
                // 这里使用腾讯财经接口（更稳定）
                const url = `https://qt.gtimg.cn/q=${codes}`;
                
                const response = await fetch(url);
                const text = await response.text();
                
                // 解析腾讯返回的数据
                // 格式: v_pvcode="code~name~...~changePercent...";
                const lines = text.trim().split(';');
                const quotes = {};
                
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const match = line.match(/v_([^\s=]+)="([^"]+)"/);
                    if (match) {
                        const code = match[1];
                        const fields = match[2].split('~');
                        // 腾讯字段: 0:市场 1:代码 2:名称 3:现价 4:昨收 5:今开 ... 32:涨跌幅%
                        if (fields.length > 32) {
                            const changePercent = parseFloat(fields[32]);
                            const name = fields[2];
                            quotes[code] = {change: changePercent, name: name};
                        }
                    }
                });

                // 填充数据
                stockList.forEach(item => {
                    const quote = quotes[item.code];
                    const input = document.querySelectorAll('.quote-change')[item.index];
                    if (quote && input) {
                        input.value = quote.change.toFixed(2);
                        // 显示颜色
                        if (quote.change > 0) input.classList.add('text-red-400');
                        else if (quote.change < 0) input.classList.add('text-green-400');
                        else input.classList.remove('text-red-400', 'text-green-400');
                    }
                });

                // 显示更新时间
                const now = new Date();
                document.getElementById('lastUpdate').classList.remove('hidden');
                document.querySelector('#lastUpdate span').textContent = now.toLocaleTimeString('zh-CN', {hour12: false});
                
                // 自动计算
                setTimeout(calculateNAV, 300);
                
            } catch (error) {
                console.error('获取行情失败:', error);
                alert('获取行情失败，请检查股票代码是否正确或手动输入');
            } finally {
                btn.disabled = false;
                btnText.textContent = '自动获取';
                icon.classList.remove('loading');
            }
        }

        // 格式化股票代码（适配腾讯接口）
        function formatStockCode(code) {
            code = code.trim();
            if (code.length === 6) {
                // 判断市场
                const firstChar = code.charAt(0);
                if (['6', '9'].includes(firstChar)) return `sh${code}`; // 上海
                if (['0', '2', '3', '4'].includes(firstChar)) return `sz${code}`; // 深圳
            }
            return code;
        }

        // 验证输入
        function validateChange(input) {
            const val = parseFloat(input.value);
            if (val > 0) {
                input.classList.remove('text-green-400');
                input.classList.add('text-red-400');
            } else if (val < 0) {
                input.classList.remove('text-red-400');
                input.classList.add('text-green-400');
            } else {
                input.classList.remove('text-red-400', 'text-green-400');
            }
        }

        // 加载示例
        function loadDemoData() {
            document.getElementById('fundCode').value = '022365';
            document.getElementById('fundName').value = '永赢科技智选混合发起C';
            
            document.getElementById('stockList').innerHTML = '';
            demoData.forEach(stock => addStockRow(stock));
            updateTotalWeight();
            renderQuoteInputs();
            saveToLocalStorage();
            
            // 3秒后自动获取行情
            setTimeout(fetchRealTimeQuotes, 500);
        }

        // 模拟数据
        function fillRandomChanges() {
            const inputs = document.querySelectorAll('.quote-change');
            inputs.forEach(input => {
                const random = (Math.random() * 6 - 2).toFixed(2);
                input.value = random;
                validateChange(input);
            });
            autoCalculate();
        }

        // 自动计算（防抖）
        let timeout;
        function autoCalculate() {
            clearTimeout(timeout);
            timeout = setTimeout(calculateNAV, 600);
        }

        // 清空
        function clearAllData() {
            if (confirm('确定要清空所有数据吗？')) {
                document.getElementById('fundCode').value = '';
                document.getElementById('fundName').value = '';
                document.getElementById('stockList').innerHTML = '';
                document.getElementById('resultSection').classList.add('hidden');
                document.getElementById('lastUpdate').classList.add('hidden');
                addStockRow();
                updateTotalWeight();
                localStorage.removeItem('fundCalculatorData');
            }
        }

        // 核心计算
        function calculateNAV() {
            saveToLocalStorage();
            
            const rows = document.querySelectorAll('.stock-row');
            const quotes = document.querySelectorAll('.quote-change');
            
            if (rows.length === 0) {
                alert('请添加持仓数据');
                return;
            }

            let totalContribution = 0;
            let totalWeight = 0;
            const details = [];

            rows.forEach((row, index) => {
                const code = row.querySelector('.stock-code').value || '--';
                const name = row.querySelector('.stock-name').value || '--';
                const weight = parseFloat(row.querySelector('.stock-weight').value) || 0;
                const change = parseFloat(quotes[index]?.value) || 0;
                
                const contribution = change * (weight / 100);
                totalContribution += contribution;
                totalWeight += weight;

                details.push({code, name, weight, change, contribution});
            });

            displayResult(totalContribution, totalWeight, details);
        }

        // 显示结果
        function displayResult(totalChange, totalWeight, details) {
            document.getElementById('resultSection').classList.remove('hidden');
            
            const resultEl = document.getElementById('resultPercent');
            const isPositive = totalChange >= 0;
            resultEl.textContent = (totalChange >= 0 ? '+' : '') + totalChange.toFixed(2) + '%';
            resultEl.className = `text-5xl font-bold tracking-tight ${isPositive ? 'positive' : 'negative'}`;
            
            document.getElementById('coveragePercent').textContent = totalWeight.toFixed(2) + '%';

            // Top3
            const sorted = [...details].sort((a, b) => b.contribution - a.contribution);
            const top3Pos = sorted.filter(d => d.contribution > 0).slice(0, 3);
            const top3Neg = sorted.filter(d => d.contribution < 0).sort((a, b) => a.contribution - b.contribution).slice(0, 3);

            document.getElementById('topPositive').innerHTML = top3Pos.length ? 
                top3Pos.map(d => `<div class="flex justify-between"><span>${d.name}</span><span class="text-red-400">${d.contribution > 0 ? '+' : ''}${d.contribution.toFixed(3)}%</span></div>`).join('') : 
                '<div class="text-slate-500">无正向贡献</div>';
            
            document.getElementById('topNegative').innerHTML = top3Neg.length ? 
                top3Neg.map(d => `<div class="flex justify-between"><span>${d.name}</span><span class="text-green-400">${d.contribution.toFixed(3)}%</span></div>`).join('') : 
                '<div class="text-slate-500">无负向贡献</div>';

            // 表格
            const tbody = document.getElementById('detailTableBody');
            tbody.innerHTML = details.map(d => `
                <tr class="text-slate-300 hover:bg-white/5 transition">
                    <td class="py-2.5 text-left">
                        <div class="font-bold text-xs font-mono text-slate-200">${d.code}</div>
                        <div class="text-[10px] text-slate-500">${d.name}</div>
                    </td>
                    <td class="py-2.5 text-right font-mono text-slate-400">${d.weight.toFixed(2)}%</td>
                    <td class="py-2.5 text-right font-mono font-bold ${d.change >= 0 ? 'positive' : 'negative'}">${d.change >= 0 ? '+' : ''}${d.change.toFixed(2)}%</td>
                    <td class="py-2.5 text-right font-mono font-bold ${d.contribution >= 0 ? 'positive' : 'negative'}">${d.contribution >= 0 ? '+' : ''}${d.contribution.toFixed(4)}%</td>
                </tr>
            `).join('');

            renderChart(details);
            
            setTimeout(() => {
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        // 渲染图表
        function renderChart(details) {
            const ctx = document.getElementById('contributionChart').getContext('2d');
            
            if (chartInstance) chartInstance.destroy();

            const labels = details.map(d => d.name);
            const data = details.map(d => d.contribution);
            const colors = details.map(d => d.contribution >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(34, 197, 94, 0.8)');
            const borderColors = details.map(d => d.contribution >= 0 ? 'rgba(239, 68, 68, 1)' : 'rgba(34, 197, 94, 1)');

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: '贡献度(%)',
                        data,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 6,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: ctx => `贡献: ${ctx.parsed.y > 0 ? '+' : ''}${ctx.parsed.y.toFixed(4)}%`
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false, drawBorder: false },
                            ticks: { color: '#64748b', font: { size: 10 } }
                        },
                        y: {
                            grid: { color: 'rgba(100, 116, 139, 0.1)', drawBorder: false },
                            ticks: { 
                                color: '#64748b',
                                callback: val => val.toFixed(2) + '%'
                            }
                        }
                    }
                }
            });
        }

        // 存储
        function saveToLocalStorage() {
            const data = {
                fundCode: document.getElementById('fundCode').value,
                fundName: document.getElementById('fundName').value,
                stocks: Array.from(document.querySelectorAll('.stock-row')).map(row => ({
                    code: row.querySelector('.stock-code').value,
                    name: row.querySelector('.stock-name').value,
                    weight: row.querySelector('.stock-weight').value
                }))
            };
            localStorage.setItem('fundCalculatorData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('fundCalculatorData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    document.getElementById('fundCode').value = data.fundCode || '';
                    document.getElementById('fundName').value = data.fundName || '';
                    document.getElementById('stockList').innerHTML = '';
                    data.stocks.forEach(stock => addStockRow(stock));
                } catch(e) {
                    console.error('加载失败', e);
                }
            }
        }

        window.onload = init;
    </script>
</body>
</html>
